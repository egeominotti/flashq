# Test build for io_uring comparison
FROM rust:latest AS builder

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    protobuf-compiler \
    libprotobuf-dev \
    build-essential \
    lld \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

COPY server/ ./

# Build argument to toggle io_uring
ARG IO_URING=false

# Build with or without io_uring
RUN if [ "$IO_URING" = "true" ]; then \
        echo "Building WITH io_uring..." && \
        cargo build --release --features io-uring; \
    else \
        echo "Building WITHOUT io_uring..." && \
        cargo build --release; \
    fi

FROM debian:trixie-slim
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/target/release/flashq-server /flashq-server
EXPOSE 6789
ENV RUST_LOG=info
CMD ["/flashq-server"]
